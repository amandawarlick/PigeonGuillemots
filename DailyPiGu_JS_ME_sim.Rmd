#####simulation from Nathan
```{r}

# Function to simulate capture-recapture data under a multi-event JS model; adapted from Kery & Schaub
   # Unobservable: number of unobservable states
n.occasions <- 82                        # Number of capture occasions
Nstar <- 500                             # Superpopulation size (total number of burrows active on at least one day)
n.states <- 4                            # not entered, egg, chick, terminated
n.obs <- 3                               # burrow visit, prey delivery, not detected
gamma <- c(0.5, seq(0.2, 0.01, length = n.occasions-1))      # Entry probabilities decrease with time
alpha <- c(.40, rep(0, n.occasions-1))   # Prob burrow is a "chick burrow" given entry (assume this only occurs on day 1)
phiA <- 0.8                              # survival state A (egg burrow)
phiB <- 0.7                              # survival state B (chick burrow)
psiAB <- 0.25                            # transition A to B conditional on survival
pA <- 0.5                                # detection for egg burrow
pB <- 0.75                               # detection for chick burrow
beta <- 0.25                             # conditional on observing chick, probability the delivery was a 'burrow visit'

#Define matrics

#state at entry
INIT.STATE <- matrix(NA,nr=n.occasions, nc=n.states) 
 for(t in 1:n.occasions){
  INIT.STATE[t,]<- c(0, 1-alpha[t], alpha[t], 0) #conditional on entry at time t, prob of entry as chick burrow 
 }

#state process conidtional on entry (survival and transition)
PHI.STATE <- array(NA, dim=c(n.states, n.states, Nstar, n.occasions))
for (i in 1:Nstar){
   for (t in 1:n.occasions){
      PHI.STATE[,,i,t] <- matrix(c(
      0,		  	0,        				0,   				0,     #this line is not needed since it is conditional on entry state
      0,           	phiA*(1-psiAB), 			phiA*psiAB,           	1-phiA,
      0,          	0,           			phiB, 			1-phiB,
      0,       		0,                    		0,            		1), nrow = n.states, byrow = TRUE)
      } #t
   } #i

#Observation process
P.OBS <- array(NA, dim=c(n.states, n.obs, Nstar, n.occasions))
for (i in 1:Nstar){
   for (t in 1:n.occasions){
      P.OBS[,,i,t] <- matrix(c(
      0,  0,  1,                   #not detected if not entered
      pA, 0,  1-pA,                #detection if egg burrow
      pB*beta,  pB*(1-beta), 1-pB, #detection if chick burrow
      0,  0,  1),                  #detection if terminated
      nrow = n.states, byrow = TRUE)
      } #t
   } #i

# Function to simulate capture-recapture data under the JS model
simul.js_ms_me <- function(PHI.STATE, P.OBS, Nstar, n.occasions, n.obs, n.states){

   z <- chTRUE <- matrix(0, ncol = n.occasions+1, nrow = Nstar) #true and observed processes including dummy occasion
   # Generate total number of entering burrows per occasion
   B <- rmultinom(1, Nstar, gamma) # Generate total number of entering burrows per occasion
   ent.occ <- numeric()
   for (t in 1:n.occasions){
      ent.occ <- c(ent.occ, rep(t+1, B[t])) #plus one to account for dummy occasion
   }

   # Simulating survival, transition, and detection
   for (i in 1:Nstar){
    #prior to entry
    z[i,1:(ent.occ[i]-1)] <- 1
    chTRUE[i,1:(ent.occ[i]-1)] <- n.obs #cannot be observed prior to capture

    #at entry occasion 
    for(t in ent.occ[i]){
     z[i,t] <-  which(rmultinom(1, 1, INIT.STATE[t-1,])==1) #state at entry occasion
     event <- which(rmultinom(1, 1, P.OBS[z[i,t],,i,t-1])==1)        #obs given state
     chTRUE[i,t] <- event
    }

    #after entry occasion
    if(ent.occ[i]<(n.occasions+1)){ #survival process if entered prior to end of study
     for(t in ent.occ[i]:n.occasions+1){
      z[i,t] <- which(rmultinom(1, 1, PHI.STATE[z[i,t-1],,i,t-1])==1) #state
      event <- which(rmultinom(1, 1, P.OBS[z[i,t],,i,t-1])==1)        #obs given state
      chTRUE[i,t] <- event
     }#t
    }#if
  }#i
   
   # Remove individuals never captured
   captured<-apply(chTRUE,1, min)<n.obs
   chOBS<-chTRUE[captured,]
   alive<-z
    alive[z==1|z==4]<-0
    alive[z==2|z==3]<-1
   Nt <- colSums(alive)    # Actual population size
   Negg <- Nchick <- NA
   for(t in 1:(n.occasions+1)){
    Negg[t]<-length(which(z[,t]==2))
    Nchick[t]<-length(which(z[,t]==3))
   }
   return(list(CH=chOBS, B=B, N=Nt, Negg=Negg, Nchick=Nchick))
}#funciton

# Execute simulation function
sim <- simul.js_ms_me(PHI.STATE, P.OBS, Nstar, n.occasions, n.obs, n.states)
CH <- sim$CH
 #verify
 sim$N
 sim$B
 sum(sim$B) #should equal simulated value of Nstar


# Add dummy occasion
#CH.du <- cbind(rep(1, dim(CH)[1]), CH)  #1 for not entered
     
# Augment data
nz <- 50
CH.aug <- rbind(CH, matrix(n.obs, nrow = nz, ncol = dim(CH)[2])) 

 get.first <- function(x) min(which(x < n.obs))
f <- apply(CH, 1, get.first)
get.last <- function(x) max(which(x < n.obs))
l <- apply(CH, 1, get.last)

#inits for state process z[i,t]
js.me.init <- function(ch, f, l, nz){
  inits <- matrix(NA, nr=dim(ch)[1], nc=dim(ch)[2])
  inits[,1] <- NA  #deterministic on occasion 1

  for(i in 1:dim(ch)[1]) { 
    inits[i,1:f[i]-1] <- 1  #1 before first capture 
    if(l[i]<dim(ch)[2]){
     inits[i, (l[i]+1):dim(ch)[2]] <- rep(3, (dim(ch)[2]-l[i])) #3 from last obs to end
    }
    if(sum(ch[i,] == 2, na.rm=T)>0){ #sites with observed prey delivery
       if(f[i]==min(which(ch[i,]  == 2))){  #if first obs is a prey delivery
        inits[i, f[i]:l[i]]<-3              #chick until end of study 
        if(f[i]>2) inits[i, 2:(f[i]-1)]<-2  #egg prior to chick

       }else{
        inits[i, f[i]:(min(which(ch[i,]  == 2))-1)]<-2
        inits[i, min(which(ch[i,]  == 2)):l[i]]<-3
       }
    }else{ #never detected a prey delivery
      if(sum(ch[i,] == 2, na.rm=T)==0){      
        inits[i, f[i]:(max(which(ch[i,]  == 1)))]<-2
      }
    }
   }#i
  return(inits)
}

zInitsObs <- js.me.init(CH, f, l, nz)
zInits<-rbind(zInitsObs,matrix(1,nr=nz, nc=dim(CH)[2]))
zInits[,1]<-NA #deterministic on first occasion

inits <- function(){list(mean.phi = runif(2, 0, 1), 
                         mean.p = runif(2, 0, 1), 
                         z = zInits)}    
#data
jags.data <- list(y = CH.aug, n.occasions = n.occasions+1 , M = dim(CH.aug)[1])
   
# Parameters monitored
parameters <- c("mean.phi", "mean.p", "beta", "gamma", "alphaKeep", "mean.psiAB","N.egg","N.chick",
                "N.active","Nstar","psi","b")

# MCMC settings
nc <- 3; nAdapt <- 500; nb <- 100;  ni <- 1000; nt <- 1

# Run
js_me <- jags(jags.data, inits, parameters, model.file = "model_JS_MS_ME.txt",
              n.chains = nc, n.adapt=nAdapt, n.thin = nt, n.iter = ni, n.burnin = nb, parallel=T)

plot(js_me$samples[,"alphaKeep"])

#abundances
outmat<-as.matrix(js_me$samples)
plot(apply(outmat[,grep("N.active\\[", colnames(outmat))],2,median), pch=16, type="b", ylab="Number", xlab=c("Day of season"), ylim=c(0,Nstar))
points(apply(outmat[,grep("N.egg\\[", colnames(outmat))],2,median), pch=16, type="b", col="red")
points(apply(outmat[,grep("N.chick\\[", colnames(outmat))],2,median), pch=16, type="b", col="blue")
legend("topleft", legend=c("Active","Egg", "Chick"), text.col=c("black", "red", "blue"), bty="n")
 #true values
 points(sim$N[2:(n.occasions+1)], pch=0)
 points(sim$Negg[2:(n.occasions+1)], pch=0, col="red")
 points(sim$Nchick[2:(n.occasions+1)], pch=0, col="blue")

#estimated 'birth' rates
plot(apply(outmat[,grep("b\\[", colnames(outmat))],2,median), pch=16, type="b", ylab="Probability", xlab=c("Day of season"), ylim=c(0,1))
 points(b, pch=0) #true values



```

