\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={ESRM451Script},
            pdfauthor={Amanda Warlick},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{ESRM451Script}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Amanda Warlick}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{3/19/2019}


\begin{document}
\maketitle

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#install.packages('rstudioapi')}
\CommentTok{# install.packages(c('rjags', 'jagsUI', 'R2OpenBUGS', 'dplyr', 'tidyr', 'reshape2', 'data.table', 'ggplot2', 'scales', 'knitr', 'stringr', 'lubridate', 'stats', 'zoo'))}

\CommentTok{#library(rstudioapi)}
\KeywordTok{library}\NormalTok{(rjags)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Loading required package: coda
\end{verbatim}

\begin{verbatim}
## Linked to JAGS 4.3.0
\end{verbatim}

\begin{verbatim}
## Loaded modules: basemod,bugs
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#library(R2jags) #seems to fight with jagsUI}
\KeywordTok{library}\NormalTok{(jagsUI)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Loading required package: lattice
\end{verbatim}

\begin{verbatim}
## 
## Attaching package: 'jagsUI'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:coda':
## 
##     traceplot
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:utils':
## 
##     View
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(R2OpenBUGS)}
\KeywordTok{library}\NormalTok{(dplyr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'dplyr'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:stats':
## 
##     filter, lag
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyr)}
\KeywordTok{library}\NormalTok{(reshape2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'reshape2'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:tidyr':
## 
##     smiths
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(data.table)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'data.table'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:reshape2':
## 
##     dcast, melt
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:dplyr':
## 
##     between, first, last
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggplot2)}
\CommentTok{#library(cowplot) }
\KeywordTok{library}\NormalTok{(loo)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## This is loo version 2.0.0.
## **NOTE: As of version 2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session. Visit mc-stan.org/loo/news for details on other changes.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(scales)}
\KeywordTok{library}\NormalTok{(knitr)}
\KeywordTok{library}\NormalTok{(stringr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'lubridate'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:data.table':
## 
##     hour, isoweek, mday, minute, month, quarter, second, wday,
##     week, yday, year
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:base':
## 
##     date
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(stats) }
\KeywordTok{library}\NormalTok{(IDPmisc)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'IDPmisc' was built under R version 3.5.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(zoo)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'zoo'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:base':
## 
##     as.Date, as.Date.numeric
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(magrittr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'magrittr'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:tidyr':
## 
##     extract
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# path <- getActiveDocumentContext()$path }
\CommentTok{# setwd(dirname(path))}
\CommentTok{#print(getwd())}

\CommentTok{#setwd("~/Documents/SAFS/PigeonGuillemots")}
\CommentTok{#setwd("C:\textbackslash{}\textbackslash{}Nathan\textbackslash{}\textbackslash{}UW\textbackslash{}\textbackslash{}projects\textbackslash{}\textbackslash{}PigeonGuillemotNestSurvival\textbackslash{}\textbackslash{}data")}
\NormalTok{opts_chunk}\OperatorTok{$}\KeywordTok{set}\NormalTok{(}\DataTypeTok{fig.width=}\FloatTok{6.5}\NormalTok{, }\DataTypeTok{fig.height=}\DecValTok{4}\NormalTok{, }\DataTypeTok{warning=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{message=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{echo =}\NormalTok{ T, }\DataTypeTok{eval =}\NormalTok{ F, }\DataTypeTok{fig.align =} \StringTok{'center'}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#load data from PigeonGuillemot_whidbey.Rmd}
\CommentTok{#contains single row where burrow_name == NA when no activity was detected, but survey started}
\NormalTok{data_burrow_all <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"data_burrow.csv"}\NormalTok{, }\DataTypeTok{header =}\NormalTok{ T, }\DataTypeTok{stringsAsFactors =}\NormalTok{ F) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(region }\OperatorTok{==}\StringTok{ 'Whidbey'}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\KeywordTok{c}\NormalTok{(Gunnel, Sculpin, Other)) }\OperatorTok{%>%}
\StringTok{  }\CommentTok{#filter(site %in% c('Double Bluff North')) %>%}
\StringTok{  }\CommentTok{#filter(site %in% c('Mutiny Sands', 'Double Bluff North')) %>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{>}\StringTok{ }\DecValTok{2016}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{distinct}\NormalTok{()  }\CommentTok{#2 duplicates, all lagoon south 2017}

\CommentTok{#study start day per year, island-wide}
\NormalTok{start_end_all <-}\StringTok{ }\NormalTok{data_burrow_all }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(year, region) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{start_day =} \KeywordTok{min}\NormalTok{(yday, }\DataTypeTok{na.rm =}\NormalTok{ T), }\DataTypeTok{end_day =} \KeywordTok{max}\NormalTok{(yday, }\DataTypeTok{na.rm =}\NormalTok{ T))}

\NormalTok{no_vis <-}\StringTok{ }\NormalTok{data_burrow_all }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(burrow_name)) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(region, year, site, week, yday)}

\NormalTok{all_days <-}\StringTok{ }\NormalTok{data_burrow_all }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{distinct}\NormalTok{(yday)}
\NormalTok{fill <-}\StringTok{ }\NormalTok{data_burrow_all }\OperatorTok{%>%}\StringTok{  }\CommentTok{#all day-burrow combinations}
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(burrow_name)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site, burrow_name) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{distinct}\NormalTok{(burrow_name) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(all_days, }\DataTypeTok{all =}\NormalTok{ T) }

\NormalTok{burrow <-}\StringTok{ }\NormalTok{data_burrow_all }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(burrow_name)) }\OperatorTok{%>%}\StringTok{ }\CommentTok{#remove all dummy rows where no burrows were seen}
\StringTok{  }\KeywordTok{merge}\NormalTok{(fill, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'site'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'burrow_name'}\NormalTok{, }\StringTok{'yday'}\NormalTok{), }\DataTypeTok{all =}\NormalTok{ T) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(start_end_all, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{), }\DataTypeTok{all =}\NormalTok{ T) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{study_day =}\NormalTok{ yday }\OperatorTok{-}\StringTok{ }\NormalTok{start_day }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{) }\CommentTok{#%>% arrange(burrow_name)}

\CommentTok{#burrow visit and prey visit start stops}
\NormalTok{prey_start_end <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(tot_prey }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site, burrow_name) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{prey_start =} \KeywordTok{min}\NormalTok{(study_day), }\DataTypeTok{prey_end =} \KeywordTok{max}\NormalTok{(study_day))  }

\NormalTok{bv_start_end <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(burrow_visit }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site, burrow_name) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{bv_start =} \KeywordTok{min}\NormalTok{(study_day), }\DataTypeTok{bv_end =} \KeywordTok{max}\NormalTok{(study_day))  }

\NormalTok{start_end_visits <-}\StringTok{ }\NormalTok{prey_start_end }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(bv_start_end, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{, }\StringTok{'burrow_name'}\NormalTok{), }\DataTypeTok{all =}\NormalTok{ T)}

\NormalTok{day_range <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{min_day =} \KeywordTok{min}\NormalTok{(study_day, }\DataTypeTok{na.rm =}\NormalTok{ T), }\DataTypeTok{max_day =} \KeywordTok{max}\NormalTok{(study_day, }\DataTypeTok{na.rm =}\NormalTok{ T))}

\NormalTok{week_range <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{min_week =} \KeywordTok{min}\NormalTok{(week), }\DataTypeTok{max_week =} \KeywordTok{max}\NormalTok{(week))}

\NormalTok{n_visits <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site) }\OperatorTok{%>%}\StringTok{ }\CommentTok{#don't include burrow here, since hasn't been expanded yet}
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{n_visits =} \KeywordTok{n_distinct}\NormalTok{(study_day)) }\CommentTok{#use study_day instead of date - NAs in date}

\CommentTok{#combining all data with dummy framework of all days, create capture history}
\NormalTok{burrow_CH <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(start_end_visits, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{, }\StringTok{'burrow_name'}\NormalTok{), }\DataTypeTok{all.x =}\NormalTok{ T) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{prey_days =}\NormalTok{ prey_end }\OperatorTok{+}\StringTok{ }\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{prey_start) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{bv_days =}\NormalTok{ bv_end }\OperatorTok{+}\StringTok{ }\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{bv_start) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(day_range, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(n_visits, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }\CommentTok{#arrange(burrow_name)}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{capt_hist =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(burrow_visit) }\OperatorTok{&}\StringTok{ }\KeywordTok{is.na}\NormalTok{(tot_prey), }\DecValTok{3}\NormalTok{, }\CommentTok{#observed but not detected}
                     \KeywordTok{ifelse}\NormalTok{(burrow_visit }\OperatorTok{==}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{tot_prey }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\CommentTok{#observed but not detected}
              \KeywordTok{ifelse}\NormalTok{(tot_prey }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\CommentTok{#prey visit}
              \KeywordTok{ifelse}\NormalTok{(burrow_visit }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\CommentTok{#burrow visit}
                       \DecValTok{100}\NormalTok{))))) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(region, year, site, week, yday, start_day, study_day, n_visits, }
\NormalTok{         min_day, max_day, burrow_name, capt_hist) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{distinct}\NormalTok{() }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dcast}\NormalTok{(region }\OperatorTok{+}\StringTok{ }\NormalTok{year }\OperatorTok{+}\StringTok{ }\NormalTok{site }\OperatorTok{+}\StringTok{ }\NormalTok{burrow_name }\OperatorTok{+}\StringTok{ }\NormalTok{min_day }\OperatorTok{+}\StringTok{ }\NormalTok{max_day }\OperatorTok{~}\StringTok{ }\NormalTok{study_day, }\DataTypeTok{value.var =} \StringTok{'capt_hist'}\NormalTok{, }
        \DataTypeTok{fun.aggregate =}\NormalTok{ mean) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(burrow_name))}

\CommentTok{#now we have ch df, but too many 3s - need to make NA outside site-specific start/stop days}
\NormalTok{burrow_CH <-}\StringTok{ }\NormalTok{burrow_CH }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{melt}\NormalTok{(}\DataTypeTok{id.vars =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{, }\StringTok{'burrow_name'}\NormalTok{, }\StringTok{'min_day'}\NormalTok{, }\StringTok{'max_day'}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{study_day =} \KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(variable))) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{capt_hist =} \KeywordTok{ifelse}\NormalTok{(study_day }\OperatorTok{<}\StringTok{ }\NormalTok{min_day }\OperatorTok{|}\StringTok{ }\NormalTok{study_day }\OperatorTok{>}\StringTok{ }\NormalTok{max_day, }\OtherTok{NA}\NormalTok{, value)) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(region, year, site, burrow_name, study_day, capt_hist) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{dcast}\NormalTok{(region }\OperatorTok{+}\StringTok{ }\NormalTok{year }\OperatorTok{+}\StringTok{ }\NormalTok{site }\OperatorTok{+}\StringTok{ }\NormalTok{burrow_name }\OperatorTok{~}\StringTok{ }\NormalTok{study_day, }\DataTypeTok{value.var =} \StringTok{'capt_hist'}\NormalTok{) }

\CommentTok{#df of survey days at burrow-week level}
\NormalTok{survey <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(n_visits, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(week_range, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(region, year, site, yday, burrow_name, study_day, n_visits, week, max_week) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dcast}\NormalTok{(region }\OperatorTok{+}\StringTok{ }\NormalTok{year }\OperatorTok{+}\StringTok{ }\NormalTok{site }\OperatorTok{+}\StringTok{ }\NormalTok{burrow_name }\OperatorTok{+}\StringTok{ }\NormalTok{n_visits }\OperatorTok{~}\StringTok{ }\NormalTok{study_day, }\DataTypeTok{value.var =} \StringTok{'study_day'}\NormalTok{, }\DataTypeTok{fun.aggregate =}\NormalTok{ mean)}

\NormalTok{max_recap <-}\StringTok{ }\KeywordTok{max}\NormalTok{(survey}\OperatorTok{$}\NormalTok{n_visits) }\CommentTok{#max number of resights for ncol, NOT distinct study days}

\NormalTok{####augment - need to add X individuals prop to # of nests with the same days at a site but all obs == 3}
 
\CommentTok{# num_nests <- burrow %>%}
\CommentTok{#   group_by(region, year, site) %>%}
\CommentTok{#   summarize(nest_cnt = n_distinct(burrow_name)) %>%}
\CommentTok{#   transform(burrow_name = 'XXX') %>%}
\CommentTok{#   merge(n_visits, by = c('region', 'year', 'site')) %>%}
\CommentTok{#   transform(aug = round(0.2*nest_cnt)) %>%}
\CommentTok{#   transform(aug = ifelse(aug < 1, 1, aug)) %>%}
\CommentTok{#   dplyr::select(-nest_cnt)}
\CommentTok{# }
\CommentTok{# aug_dat <- matrix(NA, nrow = sum(num_nests$aug), ncol = max_recap)}
\CommentTok{# }
\CommentTok{# for (i in 1:dim(aug_dat)[1]) \{}
\CommentTok{# #aug_dat[i,c(1:4)] <- unlist(c(burrow_CH[i,c(1:4)]))}
\CommentTok{#   num_vis <- num_nests[1,'n_visits']}
\CommentTok{#   temp <- as.numeric(rep(3, num_vis))}
\CommentTok{# aug_dat[i,] <- c(temp, rep(NA, max_recap-num_vis))}
\CommentTok{# }
\CommentTok{# \}}

\CommentTok{#need matrix(dim(aug), region, year, site, burrow_name, rep(3, n_visits) + NA)}

\NormalTok{##collapse so that all data are at beginning, trailing NAs for the rest}
\NormalTok{ch_dat <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{dim}\NormalTok{(burrow_CH)[}\DecValTok{1}\NormalTok{], }\DataTypeTok{ncol =}\NormalTok{ max_recap)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(burrow_CH)[}\DecValTok{1}\NormalTok{]) \{}
\NormalTok{  temp <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(burrow_CH[i, }\DecValTok{4} \OperatorTok{+}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{which}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(burrow_CH[i,}\DecValTok{5}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(burrow_CH)[}\DecValTok{2}\NormalTok{]])))])}
\NormalTok{  num <-}\StringTok{ }\KeywordTok{length}\NormalTok{(temp)}
\NormalTok{  ch_dat[i,] <-}\StringTok{ }\KeywordTok{c}\NormalTok{(temp, }\KeywordTok{rep}\NormalTok{(}\OtherTok{NA}\NormalTok{, max_recap}\OperatorTok{-}\NormalTok{num))}
\NormalTok{\}}

\CommentTok{#for unique year-site combination, need vector of study_day that is length of n_visits}
\NormalTok{site_i <-}\StringTok{ }\NormalTok{survey}\OperatorTok{$}\NormalTok{site}
\NormalTok{visits_i <-}\StringTok{ }\NormalTok{survey}\OperatorTok{$}\NormalTok{n_visits}
\NormalTok{max_visits <-}\StringTok{ }\KeywordTok{max}\NormalTok{(survey}\OperatorTok{$}\NormalTok{n_visits)}
\NormalTok{year_i <-}\StringTok{ }\NormalTok{burrow_CH}\OperatorTok{$}\NormalTok{year}

\NormalTok{survey_days <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{dim}\NormalTok{(survey)[}\DecValTok{1}\NormalTok{], }\DataTypeTok{ncol =}\NormalTok{ max_visits)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(survey)[}\DecValTok{1}\NormalTok{]) \{}
\NormalTok{  temp <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(survey[i, }\DecValTok{5} \OperatorTok{+}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{which}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(survey[i,}\DecValTok{6}\OperatorTok{:}\KeywordTok{dim}\NormalTok{(survey)[}\DecValTok{2}\NormalTok{]])))])}
  \CommentTok{#num <- survey[i,5]}
\NormalTok{  num <-}\StringTok{ }\KeywordTok{length}\NormalTok{(temp)}
\NormalTok{  survey_days[i,] <-}\StringTok{ }\KeywordTok{c}\NormalTok{(temp, }\KeywordTok{rep}\NormalTok{(}\OtherTok{NA}\NormalTok{, max_visits}\OperatorTok{-}\NormalTok{num))}
\NormalTok{\}}

\NormalTok{effort <-}\StringTok{ }\NormalTok{survey_days}
\NormalTok{ch <-}\StringTok{ }\NormalTok{ch_dat}
\NormalTok{y <-}\StringTok{ }\NormalTok{ch}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# -------------------------------------------------}
\CommentTok{# Parameters:}
\CommentTok{# phiA: survival probability from egg to chick}
\CommentTok{# phiB: survival probability from chick to fledge}
\CommentTok{# psiAB: probability of transitioning from egg to chick}
\CommentTok{# pA: detection probability of egg burrow}
\CommentTok{# pB: detection probability of chick burrow}
\CommentTok{# b: conditional on there being a chick, probability of seeing just a burrow visit}
\CommentTok{# gamma: entry probability}
\CommentTok{# alpha: conditional on entry at occasion 1, probability burrow had a chick. alpha set to 0 for t>1. So if a burrow is initiated after day one, it must start as an egg burrow.  }

\CommentTok{# -------------------------------------------------}
\CommentTok{# States:}
\CommentTok{# 1 not entered}
\CommentTok{# 2 alive as egg}
\CommentTok{# 3 alive as chick}
\CommentTok{# 4 terminated; dead or fledged}

\CommentTok{# Observations:  }
\CommentTok{# 1 Burrow visit}
\CommentTok{# 2 Prey visit}
\CommentTok{# 3 not seen}
\CommentTok{# NA not observed - no survey that day}
\CommentTok{# -------------------------------------------------}

\NormalTok{model_MEJS <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{ () \{}

\CommentTok{# Priors and constraints}
\CommentTok{#for (i in 1:n_ind) \{}
\ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{(n.occasions}\OperatorTok{-}\DecValTok{1}\NormalTok{))\{}
 \CommentTok{#phiA[t] <- mean.phi[1]   # egg survival}
 \CommentTok{#logit(phiA[i, t]) <- mu.p}
 \KeywordTok{logit}\NormalTok{(phiA[t]) <-}\StringTok{ }\NormalTok{mu.phi[}\DecValTok{1}\NormalTok{]}
 \KeywordTok{logit}\NormalTok{(phiB[t]) <-}\StringTok{ }\NormalTok{mu.phi[}\DecValTok{2}\NormalTok{]}
\NormalTok{ gamma[t] }\OperatorTok{~}\StringTok{ }\KeywordTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)    }\CommentTok{# Prior for entry probabilities at occasion t}
\NormalTok{ pA[t] <-}\StringTok{ }\NormalTok{mean.p[}\DecValTok{1}\NormalTok{]     }\CommentTok{# egg burrow detection}
\NormalTok{ pB[t] <-}\StringTok{ }\NormalTok{mean.p[}\DecValTok{2}\NormalTok{]     }\CommentTok{# chick burrow detection}
\NormalTok{ psiAB[t] <-}\StringTok{ }\NormalTok{mean.psiAB}
\NormalTok{\} }\CommentTok{#t}

\NormalTok{b }\OperatorTok{~}\StringTok{ }\KeywordTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)            }\CommentTok{# prior for assignment probability}
\NormalTok{mean.psiAB }\OperatorTok{~}\StringTok{ }\KeywordTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)   }\CommentTok{# transition from egg to chick}
\NormalTok{pi }\OperatorTok{~}\StringTok{ }\KeywordTok{ddirch}\NormalTok{(alpha[}\DecValTok{1}\OperatorTok{:}\DecValTok{3}\NormalTok{])   }\CommentTok{#dirichlet prior for multinomial}
\NormalTok{alpha[}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\DecValTok{3}
\NormalTok{alpha[}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\DecValTok{3}
\NormalTok{alpha[}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\DecValTok{3}

\ControlFlowTok{for}\NormalTok{ (u }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\DecValTok{2}\NormalTok{)\{}
\NormalTok{ mu.phi[u] }\OperatorTok{~}\StringTok{ }\KeywordTok{dnorm}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.001}\NormalTok{) }
\NormalTok{ mean.p[u] }\OperatorTok{~}\StringTok{ }\KeywordTok{dunif}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)      }\CommentTok{# Priors for mean state-spec. recapture}
\NormalTok{\}}
\NormalTok{est.phiA <-}\StringTok{ }\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{+}\KeywordTok{exp}\NormalTok{(}\OperatorTok{-}\NormalTok{mu.phi[}\DecValTok{1}\NormalTok{]))}
\NormalTok{est.phiB <-}\StringTok{ }\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{+}\KeywordTok{exp}\NormalTok{(}\OperatorTok{-}\NormalTok{mu.phi[}\DecValTok{2}\NormalTok{]))}

\CommentTok{# Likelihood }
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{M)\{}
 \CommentTok{# Define latent state at first occasion}
\NormalTok{  z[i,}\DecValTok{1}\NormalTok{] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcat}\NormalTok{(pi[}\DecValTok{1}\OperatorTok{:}\DecValTok{3}\NormalTok{])      }\CommentTok{#all M individuals have probability of being in 1 of 3 states}

 \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{2}\OperatorTok{:}\NormalTok{n.occasions)\{}
  \CommentTok{# State process: draw S(t) given S(t-1); daily}
\NormalTok{  z[i,t] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcat}\NormalTok{(ps[z[i,t}\OperatorTok{-}\DecValTok{1}\NormalTok{], i, t}\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DecValTok{1}\OperatorTok{:}\DecValTok{4}\NormalTok{])}
\NormalTok{ \} }\CommentTok{#t}
   
  \CommentTok{# Observation process: draw O(t) given S(t); n_visit approach via Nathan}
  \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{visits_i[i]) \{  }
\NormalTok{  y[i,k] }\OperatorTok{~}\StringTok{ }\KeywordTok{dcat}\NormalTok{(po[z[i,effort[i,k]], i, k, }\DecValTok{1}\OperatorTok{:}\DecValTok{3}\NormalTok{]) }\CommentTok{#add indices back in if modeling p}
\NormalTok{  \} }\CommentTok{#k}
\NormalTok{\} }\CommentTok{#i}

\CommentTok{# Define transition and observation matrices}
 \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{M)\{}
  \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{(n.occasions}\OperatorTok{-}\DecValTok{1}\NormalTok{)) \{}
      \CommentTok{# Define probabilities of state S(t+1) given S(t)   }
\NormalTok{      ps[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{-}\NormalTok{gamma[t]                    }\CommentTok{#probability of not entering}
\NormalTok{      ps[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{gamma[t]                    }\CommentTok{#probability of entering as egg}
\NormalTok{      ps[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                          \CommentTok{#can't enter as a chick after day 1}
\NormalTok{      ps[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{4}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                             \CommentTok{#probability of entering as terminated}
\NormalTok{      ps[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                             \CommentTok{#probability egg goes to 'not entered'}
\NormalTok{      ps[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{psiAB[t])}\OperatorTok{*}\NormalTok{phiA[t]          }\CommentTok{#probability of surviving egg state and not transitioning}
\NormalTok{      ps[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\NormalTok{phiA[t]}\OperatorTok{*}\NormalTok{psiAB[t]              }\CommentTok{#probability of surviving egg state and hatching}
\NormalTok{      ps[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{4}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{-}\NormalTok{phiA[t]                      }\CommentTok{#probability of a failed egg}
\NormalTok{      ps[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                                \CommentTok{#probability chick goes to 'not entered'}
\NormalTok{      ps[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                                \CommentTok{#probability chick goes to egg}
\NormalTok{      ps[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\NormalTok{phiB[t]}
\NormalTok{      ps[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{4}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{-}\NormalTok{phiB[t]               }\CommentTok{#probability of failed chick}
\NormalTok{      ps[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                      \CommentTok{#probability terminated goes to 'not entered'}
\NormalTok{      ps[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                       \CommentTok{#probability terminated goes to egg (maybe happens)}
\NormalTok{      ps[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                       \CommentTok{#probability terminated goes to chick}
\NormalTok{      ps[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{4}\NormalTok{] <-}\StringTok{ }\DecValTok{1}                       \CommentTok{#probability terminated goes to terminated}
\NormalTok{  \} }\CommentTok{#t}

   \ControlFlowTok{for}\NormalTok{ (t }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{visits_i[i]) \{}
      \CommentTok{# Define probabilities of O(t) given S(t)}
\NormalTok{      po[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                        \CommentTok{#'not entered' burrow is detected with a burrow visit}
\NormalTok{      po[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                        \CommentTok{#'not entered' burrow is detected with a prey visit}
\NormalTok{      po[}\DecValTok{1}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{1}                        \CommentTok{#'not entered' burrow is not detected}
\NormalTok{      po[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\NormalTok{pA[t]                    }\CommentTok{#egg burrow is detected with a burrow visit}
\NormalTok{      po[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                        \CommentTok{#egg burrow is detected with a prey visit}
\NormalTok{      po[}\DecValTok{2}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{1}\OperatorTok{-}\NormalTok{pA[t]                  }\CommentTok{#egg burrow is not detected}
\NormalTok{      po[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\NormalTok{b }\OperatorTok{*}\StringTok{ }\NormalTok{pB[t]                }\CommentTok{#chick burrow is detected with a burrow visit }
\NormalTok{      po[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{b) }\OperatorTok{*}\StringTok{ }\NormalTok{pB[t]          }\CommentTok{#chick burrow is detected with a prey visit}
\NormalTok{      po[}\DecValTok{3}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{pB[t]                }\CommentTok{#chick burrow is not detected}
\NormalTok{      po[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                        \CommentTok{#terminated burrow is detected with a burrow visit}
\NormalTok{      po[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{0}                        \CommentTok{#terminated burrow is detected with a prey visit}
\NormalTok{      po[}\DecValTok{4}\NormalTok{,i,t,}\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{1}                        \CommentTok{#terminated burrow is not detected}
\NormalTok{  \} }\CommentTok{#t}
\NormalTok{ \}}\CommentTok{#M}

\CommentTok{#mean over study period}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{M) \{}
  \CommentTok{# for (t in 2:n.occasions) \{}
    \CommentTok{# Derived objects}
\NormalTok{  days.chick[i] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(z[i,] }\OperatorTok{==}\StringTok{ }\DecValTok{3}\NormalTok{)}
\NormalTok{  days.egg[i] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(z[i,] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{)}
\NormalTok{  fledged_high[i] <-}\StringTok{ }\KeywordTok{step}\NormalTok{(days.chick[i]}\OperatorTok{-}\DecValTok{35}\NormalTok{) }\CommentTok{#if step() greater than zero, 1}
\NormalTok{  fledged_low[i] <-}\StringTok{ }\KeywordTok{step}\NormalTok{(days.chick[i]}\OperatorTok{-}\DecValTok{42}\NormalTok{) }\CommentTok{#if step() greater than zero, 1}
\NormalTok{  everActive[i] <-}\StringTok{ }\KeywordTok{max}\NormalTok{(z[i,]}\OperatorTok{>}\DecValTok{1}\NormalTok{) }\CommentTok{#need the number of active ever}
  \CommentTok{# \} #t}
\NormalTok{ \} }\CommentTok{#i}

\CommentTok{#annual level}
\ControlFlowTok{for}\NormalTok{ (y }\ControlFlowTok{in}\NormalTok{ year_i) \{}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{M) \{}
    \CommentTok{# Derived objects}
\NormalTok{  days.chick.y[y,i] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(z[i,] }\OperatorTok{==}\StringTok{ }\DecValTok{3}\NormalTok{)}
\NormalTok{  days.egg.y[y,i] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(z[i,] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{)}
\NormalTok{  fledged_high.y[y,i] <-}\StringTok{ }\KeywordTok{step}\NormalTok{(days.chick.y[y,i]}\OperatorTok{-}\DecValTok{35}\NormalTok{) }\CommentTok{#if step() greater than zero, 1}
\NormalTok{  fledged_low.y[y,i] <-}\StringTok{ }\KeywordTok{step}\NormalTok{(days.chick.y[y,i]}\OperatorTok{-}\DecValTok{42}\NormalTok{) }\CommentTok{#if step() greater than zero, 1}
\NormalTok{  everActive.y[y,i] <-}\StringTok{ }\KeywordTok{max}\NormalTok{(z[i,]}\OperatorTok{>}\DecValTok{1}\NormalTok{) }\CommentTok{#need the number of active ever}
\NormalTok{  \} }\CommentTok{#i}
\NormalTok{ \} }\CommentTok{#y}

\CommentTok{#derive abundances }
\CommentTok{#  for (t in 1:(n.occasions-1))\{}
\CommentTok{#   # N.egg[t]    <- sum(egg[1:M,t])}
\CommentTok{#   # N.chick[t]  <- sum(chick[1:M,t])}
\CommentTok{#   # N.active[t] <- sum(active[1:M,t])}
\CommentTok{#   qgamma[t] <- 1-gamma[t] }
\CommentTok{#   #birthProb[t] <- cprob[t] / psi      # Entry probability}
\CommentTok{# \} #t}

\NormalTok{n.fledged.low <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fledged_low[}\DecValTok{1}\OperatorTok{:}\NormalTok{M])}
\NormalTok{n.fledged.low.y <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fledged_low.y[y,}\DecValTok{1}\OperatorTok{:}\NormalTok{M])}
\NormalTok{n.fledged.high <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fledged_high[}\DecValTok{1}\OperatorTok{:}\NormalTok{M])}
\NormalTok{n.active.burrow <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(everActive[}\DecValTok{1}\OperatorTok{:}\NormalTok{M])}
\NormalTok{nest.succ.low <-}\StringTok{ }\NormalTok{n.fledged.low}\OperatorTok{/}\NormalTok{n.active.burrow}
\NormalTok{nest.succ.high <-}\StringTok{ }\NormalTok{n.fledged.high}\OperatorTok{/}\NormalTok{n.active.burrow}
\NormalTok{mean.days.chick <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(days.chick)}
\NormalTok{mean.days.egg <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(days.egg)}

\NormalTok{\} }\CommentTok{#mod}

\KeywordTok{write.model}\NormalTok{(model_MEJS, }\StringTok{"model_MEJS.txt"}\NormalTok{)}
\NormalTok{model.file =}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\KeywordTok{getwd}\NormalTok{(),}\StringTok{"model_MEJS.txt"}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"/"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Bundle data}
\NormalTok{jags.data <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ y, }\DataTypeTok{n.occasions =} \KeywordTok{max}\NormalTok{(effort, }\DataTypeTok{na.rm =}\NormalTok{ T), }
                  \CommentTok{#z = z.st, }
                  \DataTypeTok{effort =}\NormalTok{ effort, }
                  \DataTypeTok{visits_i =}\NormalTok{ visits_i, }\DataTypeTok{year_i =}\NormalTok{ year_i,}
                  \DataTypeTok{M =} \KeywordTok{dim}\NormalTok{(ch)[}\DecValTok{1}\NormalTok{])}

\NormalTok{inits <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{()\{}\KeywordTok{list}\NormalTok{(}\CommentTok{#mean.phi = runif(2, 0, 1), }
                         \CommentTok{#z = z.init,}
                         \DataTypeTok{z =} \KeywordTok{matrix}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{dim}\NormalTok{(ch)[}\DecValTok{1}\NormalTok{], }\DataTypeTok{ncol =} \KeywordTok{max}\NormalTok{(effort, }\DataTypeTok{na.rm =}\NormalTok{ T)),}
                         \DataTypeTok{mean.p =} \KeywordTok{runif}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))\}  }

\CommentTok{# Parameters monitored}
\NormalTok{parameters <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{'est.phiA'}\NormalTok{, }\StringTok{'est.phiB'}\NormalTok{, }\StringTok{"mean.p"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{'fledged_low.y'}\NormalTok{, }\StringTok{'n.fledged.low.y'}\NormalTok{,}
                \StringTok{'n.active.burrow'}\NormalTok{, }\StringTok{'n.fledged.low'}\NormalTok{, }\StringTok{'n.fledged.high'}\NormalTok{, }\StringTok{'mean.days.chick'}\NormalTok{, }\StringTok{'mean.days.egg'}\NormalTok{,}
                \CommentTok{#"gamma", 'z', 'fledged', 'everActive', 'days.chick', 'days.egg',}
                \StringTok{"mean.psiAB"}\NormalTok{, }\StringTok{"N.egg"}\NormalTok{, }\StringTok{"N.chick"}\NormalTok{, }\StringTok{'nest.succ.low'}\NormalTok{, }\StringTok{'nest.succ.high'}\NormalTok{, }
                \StringTok{"N.active"}\NormalTok{, }\StringTok{"Nstar"}\NormalTok{, }\StringTok{"psi"}\NormalTok{)}
     
\CommentTok{# MCMC settings}
\NormalTok{ni <-}\StringTok{ }\DecValTok{100}\NormalTok{; nt <-}\StringTok{ }\DecValTok{1}\NormalTok{; nb <-}\StringTok{ }\DecValTok{50}\NormalTok{; nc <-}\StringTok{ }\DecValTok{2}
     
\NormalTok{out_pigu_t <-}\StringTok{ }\KeywordTok{jags}\NormalTok{(jags.data, inits, parameters, }\DataTypeTok{model.file =}\NormalTok{ model.file,}
              \DataTypeTok{n.chains =}\NormalTok{ nc, }\DataTypeTok{n.thin =}\NormalTok{ nt, }\DataTypeTok{n.iter =}\NormalTok{ ni, }\DataTypeTok{n.burnin =}\NormalTok{ nb, }\DataTypeTok{parallel =}\NormalTok{ T)}

\CommentTok{#saveRDS(out_pigu, file = 'out_pigu.rds')}

\NormalTok{out <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\StringTok{'out_up10.rds'}\NormalTok{)}

\CommentTok{#jagsUI::traceplot(out_pigu)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#print(js_me, digits = 3)}
\NormalTok{outmat<-}\KeywordTok{data.frame}\NormalTok{(}\KeywordTok{as.matrix}\NormalTok{(out}\OperatorTok{$}\NormalTok{samples))}

\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{))}

\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{nest.succ.low, }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{'42-day hatchling'}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Nest Success'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{15}\NormalTok{))}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{nest.succ.low)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{nest.succ.low, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{nest.succ.high, }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{"35-day hatchling"}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Nest Success'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{15}\NormalTok{))}
     \CommentTok{#xlab = expression(paste('Mean', ,' ', psi)), ylab = "")}
\CommentTok{# mtext(side=2,text=expression(paste("P(", psi, "|data)")),line=2)}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{nest.succ.high)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{nest.succ.high, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.days.egg, }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{""}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Days in Egg State'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.4}\NormalTok{))}
     \CommentTok{#xlab = expression(paste('Mean', ,' ', psi)), ylab = "")}
\CommentTok{# mtext(side=2,text=expression(paste("P(", psi, "|data)")),line=2)}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.days.egg)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{mean.days.egg, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.days.chick, }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{""}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Days in Chick State'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.4}\NormalTok{))}
     \CommentTok{#xlab = expression(paste('Mean', ,' ', psi)), ylab = "")}
\CommentTok{# mtext(side=2,text=expression(paste("P(", psi, "|data)")),line=2)}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.days.chick)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{mean.days.chick, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow =} \KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.p[,}\DecValTok{1}\NormalTok{], }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{""}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Egg detection probability'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{20}\NormalTok{))}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.p[,}\DecValTok{1}\NormalTok{])}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{mean.p[}\DecValTok{1}\NormalTok{], }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.p[,}\DecValTok{2}\NormalTok{], }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{""}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Chick detection probability'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{20}\NormalTok{))}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.p[,}\DecValTok{2}\NormalTok{])}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{mean.p[}\DecValTok{2}\NormalTok{], }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{b, }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{""}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Assigment probability'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{20}\NormalTok{))}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{b)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{b, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(}\KeywordTok{density}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.psiAB, }\DataTypeTok{adjust=}\DecValTok{1}\NormalTok{), }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{main=}\StringTok{""}\NormalTok{,}
     \DataTypeTok{xlab =} \StringTok{'Daily hatching probability'}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{''}\NormalTok{, }\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{20}\NormalTok{))}
\KeywordTok{rug}\NormalTok{(out}\OperatorTok{$}\NormalTok{sims.list}\OperatorTok{$}\NormalTok{mean.psiAB)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ out}\OperatorTok{$}\NormalTok{mean}\OperatorTok{$}\NormalTok{mean.psiAB, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{1}\NormalTok{)}

\CommentTok{#2 is nestling, 1 is egg, 3 is obs not seen, 0 is not observed}
\NormalTok{prey_del_plot_data <-}\StringTok{ }\NormalTok{burrow_CH }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(region }\OperatorTok{==}\StringTok{ 'Whidbey'}\NormalTok{)}
\NormalTok{prey_del_plot_data[}\KeywordTok{is.na}\NormalTok{(prey_del_plot_data)] <-}\StringTok{ }\DecValTok{0}

\NormalTok{ get.first.pv <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{min}\NormalTok{(}\KeywordTok{which}\NormalTok{(x }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{))}
\NormalTok{ first_pv <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(prey_del_plot_data, }\DecValTok{1}\NormalTok{, get.first.pv)}

\NormalTok{ get.first.bv <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{min}\NormalTok{(}\KeywordTok{which}\NormalTok{(x }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{))}
\NormalTok{ first_bv <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(prey_del_plot_data, }\DecValTok{1}\NormalTok{, get.first.bv)}

\NormalTok{ get.last.pv <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{max}\NormalTok{(}\KeywordTok{which}\NormalTok{(x }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{))}
\NormalTok{ last_pv <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(prey_del_plot_data, }\DecValTok{1}\NormalTok{, get.last.pv)}

\NormalTok{ get.last.bv <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{max}\NormalTok{(}\KeywordTok{which}\NormalTok{(x }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{))}
\NormalTok{ last_bv <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(prey_del_plot_data, }\DecValTok{1}\NormalTok{, get.last.bv)}

\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow =} \KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\DataTypeTok{mar =} \KeywordTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\DataTypeTok{cex.lab =} \DecValTok{1}\NormalTok{, }\DataTypeTok{cex.axis =}\NormalTok{ .}\DecValTok{8}\NormalTok{)}
\KeywordTok{hist}\NormalTok{(first_bv, }\DataTypeTok{breaks =} \DecValTok{50}\NormalTok{, }\DataTypeTok{main =} \StringTok{'First burrow visit'}\NormalTok{, }\DataTypeTok{xlab =} \StringTok{''}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =} \KeywordTok{mean}\NormalTok{(first_bv[}\KeywordTok{which}\NormalTok{(}\KeywordTok{is.finite}\NormalTok{(first_bv))]), }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{2}\NormalTok{)}
\KeywordTok{hist}\NormalTok{(last_bv, }\DataTypeTok{breaks =} \DecValTok{50}\NormalTok{, }\DataTypeTok{main =} \StringTok{'Last burrow visit'}\NormalTok{, }\DataTypeTok{xlab =} \StringTok{''}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =} \KeywordTok{mean}\NormalTok{(last_bv[}\KeywordTok{which}\NormalTok{(}\KeywordTok{is.finite}\NormalTok{(last_bv))]), }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{2}\NormalTok{)}
\KeywordTok{hist}\NormalTok{(first_pv, }\DataTypeTok{breaks =} \DecValTok{50}\NormalTok{, }\DataTypeTok{main =} \StringTok{'First prey visit'}\NormalTok{, }\DataTypeTok{xlab =} \StringTok{'Study day'}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =} \KeywordTok{mean}\NormalTok{(first_pv[}\KeywordTok{which}\NormalTok{(}\KeywordTok{is.finite}\NormalTok{(first_pv))]), }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{2}\NormalTok{)}
\KeywordTok{hist}\NormalTok{(last_pv, }\DataTypeTok{breaks =} \DecValTok{50}\NormalTok{, }\DataTypeTok{main =} \StringTok{'Last prey visit'}\NormalTok{, }\DataTypeTok{xlab =} \StringTok{'Study day'}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =} \KeywordTok{mean}\NormalTok{(last_pv[}\KeywordTok{which}\NormalTok{(}\KeywordTok{is.finite}\NormalTok{(last_pv))]), }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{lwd =} \DecValTok{2}\NormalTok{)}

\NormalTok{####ch_long}
 
\NormalTok{ch_long <-}\StringTok{ }\NormalTok{burrow }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(start_end_visits, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{, }\StringTok{'burrow_name'}\NormalTok{), }\DataTypeTok{all.x =}\NormalTok{ T) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{prey_days =}\NormalTok{ prey_end }\OperatorTok{+}\StringTok{ }\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{prey_start) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{bv_days =}\NormalTok{ bv_end }\OperatorTok{+}\StringTok{ }\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{bv_start) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(region, year, site) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(day_range, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{merge}\NormalTok{(n_visits, }\DataTypeTok{by =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }\CommentTok{#arrange(burrow_name)}
\StringTok{  }\KeywordTok{transform}\NormalTok{(}\DataTypeTok{capt_hist =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(burrow_visit) }\OperatorTok{&}\StringTok{ }\KeywordTok{is.na}\NormalTok{(tot_prey), }\DecValTok{3}\NormalTok{, }\CommentTok{#observed but not detected}
                     \KeywordTok{ifelse}\NormalTok{(burrow_visit }\OperatorTok{==}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{tot_prey }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\CommentTok{#observed but not detected}
              \KeywordTok{ifelse}\NormalTok{(tot_prey }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{, }\CommentTok{#prey visit}
              \KeywordTok{ifelse}\NormalTok{(burrow_visit }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\CommentTok{#burrow visit}
                       \DecValTok{100}\NormalTok{))))) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(region, year, site, week, yday, start_day, study_day, n_visits, }
\NormalTok{         min_day, max_day, burrow_name, capt_hist) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{distinct}\NormalTok{()}

\NormalTok{ pv_minmax <-}\StringTok{ }\NormalTok{ch_long }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{filter}\NormalTok{(capt_hist }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{region }\OperatorTok{!=}\StringTok{ 'SS'}\NormalTok{) }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{group_by}\NormalTok{(region, year, site, burrow_name) }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{min_pv =} \KeywordTok{min}\NormalTok{(study_day), }\DataTypeTok{max_pv =} \KeywordTok{max}\NormalTok{(study_day)) }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{rename}\NormalTok{(}\DataTypeTok{FirstPreyVisit =}\NormalTok{ min_pv, }\DataTypeTok{LastPreyVisit =}\NormalTok{ max_pv)}

\NormalTok{ bv_minmax <-}\StringTok{ }\NormalTok{ch_long }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{filter}\NormalTok{(capt_hist }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{region }\OperatorTok{!=}\StringTok{ 'SS'}\NormalTok{) }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{group_by}\NormalTok{(region, year, site, burrow_name) }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{min_bv =} \KeywordTok{min}\NormalTok{(study_day), }\DataTypeTok{max_bv =} \KeywordTok{max}\NormalTok{(study_day))}

\NormalTok{ minsmax <-}\StringTok{ }\NormalTok{pv_minmax }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{bind_rows}\NormalTok{(bv_minmax) }\OperatorTok{%>%}
\StringTok{   }\KeywordTok{melt}\NormalTok{(}\DataTypeTok{id.vars =} \KeywordTok{c}\NormalTok{(}\StringTok{'region'}\NormalTok{, }\StringTok{'year'}\NormalTok{, }\StringTok{'site'}\NormalTok{, }\StringTok{'burrow_name'}\NormalTok{))}

\NormalTok{ by_year <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(minsmax }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"Prey"}\NormalTok{, variable)), }\KeywordTok{aes}\NormalTok{(}\KeywordTok{factor}\NormalTok{(year), value), }\DataTypeTok{color =}\NormalTok{ variable) }\OperatorTok{+}
\StringTok{   }\KeywordTok{geom_boxplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{variable) }\OperatorTok{+}\StringTok{ }\KeywordTok{coord_flip}\NormalTok{() }\OperatorTok{+}
\StringTok{   }\KeywordTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Study Day"}\NormalTok{) }\OperatorTok{+}
\StringTok{   }\KeywordTok{fig_theme}\NormalTok{()}

\NormalTok{ density <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ ch_long, }\KeywordTok{aes}\NormalTok{(study_day)) }\OperatorTok{+}
\StringTok{   }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ ch_long }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(capt_hist }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{region }\OperatorTok{!=}\StringTok{ 'SS'}\NormalTok{), }\KeywordTok{aes}\NormalTok{(study_day, }\DataTypeTok{col =} \StringTok{'BV'}\NormalTok{),}
             \DataTypeTok{stat =} \StringTok{'density'}\NormalTok{) }\OperatorTok{+}
\StringTok{   }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ ch_long }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(capt_hist }\OperatorTok{==}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{region }\OperatorTok{!=}\StringTok{ 'SS'}\NormalTok{), }\KeywordTok{aes}\NormalTok{(study_day, }\DataTypeTok{col =} \StringTok{'PV'}\NormalTok{),}
             \DataTypeTok{stat =} \StringTok{'density'}\NormalTok{) }\OperatorTok{+}
\StringTok{   }\CommentTok{#geom_vline(aes(xintercept = 40), linetype = 'dotted', col = 'darkgrey') +}
\StringTok{   }\CommentTok{#geom_vline(aes(xintercept = 20), linetype = 'dotted', col = 'darkgrey') +}
\StringTok{   }\KeywordTok{scale_y_continuous}\NormalTok{(}\DataTypeTok{limit =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.025}\NormalTok{)) }\OperatorTok{+}
\StringTok{   }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Relative Frequency Density"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{xlab}\NormalTok{(}\StringTok{"Study Day"}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{   }\CommentTok{#facet_wrap(~region) +}
\StringTok{   }\KeywordTok{scale_color_manual}\NormalTok{(}\DataTypeTok{values =} \KeywordTok{c}\NormalTok{(}\StringTok{"#e45f56"}\NormalTok{, }\StringTok{"#363e7e"}\NormalTok{)) }\OperatorTok{+}
\StringTok{   }\KeywordTok{fig_theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{'top'}\NormalTok{)}


 \CommentTok{# capt_hist_day <- ggplot(data_MEJS %>% filter(region == 'Whidbey' & capt_hist < 3),}
 \CommentTok{#                 aes(y = capt_hist, x = study_day)) +}
 \CommentTok{#                 geom_point(position = 'jitter')}
\end{Highlighting}
\end{Shaded}


\end{document}
