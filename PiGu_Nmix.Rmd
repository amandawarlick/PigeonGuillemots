

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages('rstudioapi')
# install.packages(c('rjags', 'jagsUI', 'R2OpenBUGS', 'dplyr', 'tidyr', 'reshape2', 'data.table', 'ggplot2', 'scales', 'knitr', 'stringr', 'lubridate', 'stats', 'zoo'))

library(rstudioapi)
library(rjags)
#library(R2jags) #seems to fight with jagsUI
library(jagsUI)
library(R2OpenBUGS)
library(dplyr)
library(tidyr)
library(reshape2)
library(data.table)
library(ggplot2)
#library(cowplot) 
library(loo)
library(scales)
library(knitr)
library(stringr)
library(lubridate)
library(stats) 
library(IDPmisc)
library(zoo)
library(magrittr)

path <- getActiveDocumentContext()$path 
setwd(dirname(path))

```


```{r counts}

#colony level
counts <- read.csv('count_dat.csv', header = T, stringsAsFactors = F) 

count_dat <- counts %>%
  select(year, site, week, PG_count) %>%
  filter(week < 33 & week > 26) 

count_wide <- count_dat %>%
  dcast(year + site ~ week, value.var = 'PG_count', fun.aggregate = mean)

cnt <- matrix(NA, nrow = dim(count_wide)[1], ncol = 8)
for (i in 1:dim(count_wide)[1]) {
  temp <- round(as.numeric(count_wide[i, 2 + c(which(!is.na(count_wide[i,3:dim(count_wide)[2]])))]))
  num <- length(temp)
  cnt[i,] <- c(temp, rep(NA, 8-num))
}

#look at mean/var
cnt_test <- as.data.frame(cnt[,1:3])


y_cnt <- cnt[,1:3] #just start w/ 3 obs?
site_cnt <- count_dat[,'site']
year <- count_dat[,'year']

#island level
count_yr <- counts %>%
  group_by(year, week) %>%
  summarize(PG_count = sum(PG_count, na.rm = T), bv = sum(bv, na.rm = T), pv = sum(pv, na.rm = T),
            v = mean(v, na.rm = T), temp = mean(temp, na.rm = T),
            mins = mean(mins, na.rm = T), upwell = mean(upwell, na.rm = T)) 
height <- count_yr %>%
  select(year, week, v) %>%
  filter(week > 26 & week < 32) %>%
  dcast(year ~ week, value.var = 'v')
#height[11,2:6] <- NA
temp <- count_yr %>%
  select(year, week, temp) %>%
  filter(week > 26 & week < 32) %>%
  dcast(year ~ week, value.var = 'temp')
#temp[9:11,2:6] <- NA
upwell_j <- count_yr %>%
  select(year, week, upwell) %>%
  filter(week > 26 & week < 32) %>%
  dcast(year ~ week, value.var = 'upwell')
upwell_i <- count_yr %>%
  select(year, week, upwell) %>%
  group_by(year) %>%
  summarize(up = mean(upwell))

yr_cnt <- count_yr %>%
  select(year, week, PG_count) %>%
  filter(week > 26 & week < 32) %>%
  dcast(year ~ week, value.var = 'PG_count', fun.aggregate = mean)

#test mean/var
test <- yr_cnt %>%
  group_by(year) %>%
  summarize(mean = mean(c(`27`, `28`, `29`, `30`, `31`)), 
            var = var(c(`27`, `28`, `29`, `30`, `31`)))

# ggplot(yr_cnt %>% melt(id.vars = 'year'), aes(variable, value, group = year)) +
#   geom_line() + geom_point() +
#   facet_wrap(~year)
# 
# summary(lm(value ~ variable + year, 
#            yr_cnt %>% melt(id.vars = 'year') %>% transform(variable = as.numeric(variable))))
  
```



```{r null}
nMix <- function () {
  
  #priors
  lambda ~ dunif(0,200)
  #lambda ~ dgamma(0.005, 0.005) #this does not work - wild estimates, low p
  p ~ dunif(0,1)

  #likelihood
  ##ecological process
  for (i in 1:R) { #R is nrow (number of years or colony-year combinations)
    N[i] ~ dpois(lambda)
    ###obs process
    for (j in 1:reps) { #reps is number of week replicates in the sample
      y[i,j] ~ dbin(p, N[i])
    } #j
    N_est[i] <- sum(N[i])
  } #i
}

write.model(nMix, "nMix.txt")
model.file = paste(getwd(),"nMix.txt", sep="/")

```


```{r mess}

nMix <- function () {
  
  #priors
  for (i in 1:R) {
  
  lambda[i] <- a0 #dunif(0,200)
  #log(lambda[i]) <- a0 #+ a.upwell*upwell_i[i]
  #mu.lam[i] <- exp(lambda[i]) #mean lambda per year
  
  for (j in 1:reps) {
    logit.p[i,j] <- b0 #+ b.upwell*upwell_j[i,j]
    #logit(logit.p[i,j]) <- b0 #+ b.upwell*upwell_j[i,j]  #plogit on logit scale
    p[i,j] <- exp(logit.p[i,j])/(1+exp(logit.p[i,j])) #p must be on probability scale
  }
  }
  
  b0 ~ dunif(-10, 10)
  # b0 <- log(int.p/(1 - int.p))
  # int.p ~ dunif(0,1)
  b.upwell ~ dunif(-10,10)
  
  #lambda ~ dunif(0,10)
  a0 ~ dunif(0,200)
  a.upwell ~ dunif(-10,10) #effect on N

  #likelihood
  ##ecological process
  for (i in 1:R) { #R is nrow (number of years or colony-year combinations)
    N[i] ~ dpois(lambda[i])
    #N[i] ~ dpois(lambda)
    ###obs process
    for (j in 1:reps) { #reps is number of week replicates in the sample
      y[i,j] ~ dbin(p[i,j], N[i])
    } #j
    N_est[i] <- sum(N[i])
  } #i
}

write.model(nMix, "nMix.txt")
model.file = paste(getwd(),"nMix.txt", sep="/")

```

```{r nMix covs}

nMix <- function () {
  
  #priors
  for (i in 1:R) {
  #lambda ~ dgamma(0.005, 0.005)
  log(lambda[i]) <- lambda.mu + b.upwell*upwell_i[i] 
  
  for (j in 1:reps) {
    #p[i,j] <- exp(logit.p[i,j])/(1+exp(logit.p[i,j])) #plogis() from logit to prob space, so p is prob
    #logit(logit.p[i,j]) <- p.mu + b.height*height[i,j] + b.up.p*upwell_j[i,j]
    logit(p[i,j]) <- p.mu + b.height*height[i,j] + b.up.p*upwell_j[i,j]
  }
  }
  p.mu ~ dnorm(0,0.001)
  p.mean <- 1/(1+exp(-p.mu))
  b.up.p ~ dnorm(0,0.001)#I(-10,10)
  b.height ~ dnorm(0,0.001)#I(-10,10)
  #p.est[i] <- 1/(1+exp(-(p.mu+b.height*height[i,j]+b.up.p*upwell_j[i,j])))
  #b.height ~ dunif(-10,10)
  #b.up.p ~ dunif(-10,10) #effect on detection

  b.upwell ~ dunif(-10,10) #effect on N
  lambda.mu ~ dunif(-10,10)
 
  # for (i in 1:R) {
  # lambda.mu[i] ~ dunif(0,10)
  # }
  
  #likelihood
  ##ecological process
  for (i in 1:R) { #R is nrow (number of years or colony-year combinations)
    N[i] ~ dpois(lambda[i])
    ###obs process
    for (j in 1:reps) { #reps is number of week replicates in the sample
      y[i,j] ~ dbin(p[i,j], N[i])
    } #j
    N_est[i] <- sum(N[i])
  } #i
}

write.model(nMix, "nMix.txt")
model.file = paste(getwd(),"nMix.txt", sep="/")

```

```{r nMix run}

# Bundle data

y <- y_cnt #colony level
#y <- as.matrix(yr_cnt[,2:dim(yr_cnt)[2]]) #island level
jags.data <- list(y = y, 
                  # temp = as.matrix(temp[,2:6]), 
                  # upwell_j = as.matrix(upwell_j[,2:6]), 
                  # upwell_i = as.matrix(upwell_i[,2]),
                  # height = as.matrix(height[,2:6]),
                  R = nrow(y), reps = ncol(y))

Nst <- apply(y, 1, max, na.rm = T) + 1
inits <- function(){list(N = Nst, b0 = runif(1,-1,1))}  

# Parameters monitored
parameters <- c('p.mu', 'p.mean', 'b0', 
                #'p', 
                'a0', 
                'N_est', 
                'b.upwell', 'b.height', 'b.up.p', 'lambda')
     
# MCMC settings
ni <- 1000; nt <- 1; nb <- 500; nc <- 3
     
(out_sim <- jags(jags.data, inits, parameters, model.file = model.file,
              n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb, parallel = T))

#out <- update(out, n.iter = 40000)

#jagsUI::traceplot(out_n)

```

```{r}

# par(mfrow = c(2,2))
# plot(density(rpois(1e5, 1000)), col = 'blue')
# plot(density(rpois(1e5, 100)), col = 'red')
# plot(density(rpois(1e5, 10)), col = 'black')
# plot(density(rpois(1e5, 1)), col = 'green')

```



```{r mini sim}

# R <- 200
# reps <- 3
# 
# y <- array(dim = c(R, reps))
# 
# N <- rpois(R, 4)
# 
# for (j in 1:reps) {
#   y[,j] <- rbinom(n = R, size = N, 0.5)
# }

```

