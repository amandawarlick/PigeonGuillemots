---
title: "Pigeon Guillemot Data Exploration - Whidbey"
output:
  word_document:
    reference_docx: mytemplate.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, error = F, messages = F, results = 'asis', fig.width = 11, fig.height = 8)
```

```{r, results = 'hide'}

library(tidyr)
#library(ggmap)
library(data.table)
library(ggfortify)
library(dplyr)
library(ggplot2)
library(cowplot)
library(scales)
#library(captioner)
library(knitr)
library(reshape2)
library(stringr)
library(magrittr) 
#library(ggTimeSeries)
library(stats) 
library(zoo)
library(sciplot) #se()
library(gvlma) #universal assumptions test gvlma(mod)

fig_theme <- function(...) {
  theme(text = element_text(family = 'Times'),
    #text = element_text(size = 11),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black", size = 10),
    axis.text.y = element_text(vjust = 0.5, color = "black", size = 10), 
    axis.title = element_text(size = 10),
    axis.line.y = element_line(colour = "black"), 
    axis.line.x = element_line(colour = "black"), 
    plot.background = element_rect(), 
    strip.text = element_text(size = 10),
    #strip.background = element_blank(),
    panel.background = element_blank(), 
    panel.grid = element_blank(), 
    legend.title = element_blank(),
    legend.key = element_blank(),
    legend.text = element_text(size = 8),
    ...)
}

fig_theme_1 <- function(...) {
  theme(text = element_text(family = 'Times'),
    #text = element_text(size = 11),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black", size = 11),
    axis.text.y = element_text(vjust = 0.5, color = "black", size = 11), 
    axis.title = element_text(size = 12),
    axis.line.y = element_line(colour = "black"), 
    axis.line.x = element_line(colour = "black"), 
    plot.background = element_rect(), 
    strip.text = element_text(size = 10),
    #strip.background = element_blank(),
    panel.background = element_blank(), 
    panel.grid = element_blank(), 
    legend.title = element_blank(),
    legend.key = element_blank(),
    legend.text = element_text(size = 10),
    ...)
}

color3 <- c("#3b98ee", "#a3d39c", "#e45f56", "#f6b61c")

```


```{r data, results = 'hide', message = FALSE}

#read in data, created needed columns

setwd("~/Documents/SAFS/PigeonGuillemots/WhidbeyData")

data_count <- read.csv("PGdata_08_17.csv", stringsAsFactors = F) %>%
  transform(date = as.Date(date, format = "%m/%d/%y")) %>%
  transform(year = format(date, "%Y")) %>%
  mutate(PG_count = as.numeric(PG_count), burrow_count = as.numeric(burrow_count), 
         burrow_visit = as.numeric(burrow_visit)) %>%
  transform(week = strftime(date, format = "%V")) %>%
  #transform(week = as.numeric(week)) %>%
  transform(week = as.numeric(as.character(week))) %>%
  transform(yday = yday(date)) 
data_count[is.na(data_count)] <- 0

data_count <- data_count %>%
  transform(id = 1:nrow(data_count))

#dates for empty burrow visits (bvs not recorded in burrow-level data, so use dates of count data and merge in)

count_dates <- data_count %>%
  filter(intern_data != 'Y') %>%
  distinct(site, date, year, week, yday) 

data_burrow <- read.csv("burrow_08_17.csv", stringsAsFactors = F) %>%
  transform(date = as.Date(date, format = "%m/%d/%y")) %>%
  transform(year = format(date, "%Y")) %>%
  mutate(Gunnel = coalesce(as.numeric(Gunnel), 0)) %>% #forcing NAs to 0, other ways weren't working
  mutate(Sculpin = coalesce(as.numeric(Sculpin), 0)) %>%
  mutate(Other = coalesce(as.numeric(Other), 0)) %>%
  mutate(burrow_visit = coalesce(as.numeric(burrow_visit), 0)) %>%
  mutate(burrow_name = gsub("-","", burrow_name)) %>%
  transform(week = strftime(date, format = "%V")) %>%
  #transform(week = as.numeric(week)) %>%
  transform(week = as.numeric(as.character(week))) %>%
  transform(yday = yday(date)) %>%
  transform(tot_prey = Gunnel + Sculpin + Other) %>%
  select(site, year, date, yday, week, burrow_name, burrow_visit, burrow_visit,
         Gunnel, Sculpin, Other, tot_prey, intern_data) %>%
  merge(count_dates, by = c('site', 'year', 'date', 'week', 'yday'), all = T) #check these get added on ALL burrow_name
data_burrow <- data_burrow %>%
  transform(id = 1:nrow(data_burrow))

#adding on columns for number of weeks of prey deliveries
prey_weeks_range <- data_burrow %>% 
  group_by(site, year, burrow_name) %>%
  filter(tot_prey > 0) %>%
  summarize(start_prey = min(week), end_prey = max(week)) %>%
  transform(prey_week_range = end_prey - (start_prey-1))
prey_weeks <- data_burrow %>% 
  group_by(site, year, burrow_name) %>%
  filter(tot_prey > 0) %>%
  #filter(intern_data == 'Y') %>%
  summarize(prey_weeks = n_distinct(week)) %>%
  #transform(nest_succ = ifelse(prey_weeks > 2, 'Y', 'N')) %>%
  merge(prey_weeks_range, by = c('year', 'site', 'burrow_name')) %>%
  transform(prey_discrep = prey_week_range - prey_weeks) %>%
  transform(nest_succ = ifelse(prey_week_range > 2, 'Y', 'N'))

setwd("~/Documents/SAFS/PigeonGuillemots")
#write.csv(data, "PG_data_all.csv", row.names = F)
write.csv(prey_weeks, "prey_weeks.csv", row.names = F)
write.csv(data_burrow, "data_burrow.csv", row.names = F)
write.csv(data_count, "data_count.csv", row.names = F)

#combining Rolling Hills sites for count data, but not burrow data - edited by hand
# RH <- data_count %>%
#   filter(intern_data != 'Y') %>%
#   filter(grepl("Rolling Hills #", site)) %>%
#   #group_by(year, week) %>%
#   group_by(year, week) %>%
#   summarize(PG_count = sum(PG_count), burrow_count = sum(burrow_count), burrow_visit = sum(burrow_visit))
# dates <- data_count %>%
#     filter(intern_data != 'Y') %>%
#   filter(grepl("Rolling Hills #", site)) %>%
#   group_by(year, week) %>%
#   summarize(date = min(date)) %>%
#   select(year, week, date)
# RH <- RH %>%
#   merge(dates, by = c('year', 'week'), all.x = T)
# write.csv(RH, "rollinghillsfix.csv", row.names = F)

```


```{r}
#peak/trimmed counts

peak_mean <- data_count %>%
  filter(intern_data != 'Y') %>%
  group_by(year, week) %>%
  summarize(mean_cnt = mean(PG_count, na.rm = T), se = se(PG_count, na.rm = T)) 

peak_sum <- data_count %>%
  filter(intern_data != 'Y') %>%
  select(year, week, site, PG_count) %>%
  distinct() %>%
  group_by(year, week) %>%
  summarize(sum_cnt = sum(PG_count, na.rm = T))

peak_plot <- ggplot(peak_mean, aes(week, mean_cnt, group = year, color = year)) +
  geom_line() + 
  geom_ribbon(aes(ymin = mean_cnt - se, ymax = mean_cnt + se), alpha = 0.4, linetype = 'blank') +
  fig_theme(legend.position = 'none') + facet_wrap(~year) #+
 #guides(color = guide_legend(override.aes=list(fill=NA)))

peak_plot_sum <- ggplot(peak_sum, aes(week, sum_cnt, group = year, color = year)) +
  geom_line() + 
  facet_wrap(~year) +
  fig_theme(legend.position = 'none') 

#######
## want the chunk where majority of birds were present, which varies per year/site

#trying means - I don't think this is sensitive enough
# mean_yr <- data %>%
#   filter(intern_data != 'Y') %>%
#   group_by(year) %>%
#   summarize(mean_cnt = mean(PG_count, na.rm = T)) 
# week_perc <- data %>%
#   filter(intern_data != 'Y') %>%
#   group_by(year, week) %>%
#   summarize(cnt = mean(PG_count, na.rm = T)) %>%
#   merge(mean_yr, by = c('year')) %>%
#   transform(perc_week = cnt/mean_cnt)

#trying max - this looks much better
max_yr <- data_count %>%
  filter(intern_data != 'Y') %>%
  select(year, week, site, PG_count) %>%
  distinct() %>%
  group_by(year, week) %>%
  summarize(sum = sum(PG_count, na.rm = T)) %>%
  group_by(year) %>%
  summarize(max_cnt = max(sum, na.rm = T)) 
week_perc <- data_count %>%
  filter(intern_data != 'Y') %>%
  select(year, week, site, PG_count) %>%
  distinct() %>%
  group_by(year, week) %>%
  summarize(cnt = sum(PG_count, na.rm = T)) %>% #sum across colonies
  merge(max_yr, by = c('year')) %>%
  transform(perc_week = cnt/max_cnt)

#only keep weeks where count was at least 65% of max count in that year
#first tried 50%, but that captured a steep downturn for a few years, this looks much better
weekly_count_isl_trim <- week_perc %>%
  filter(perc_week > 0.499) %>%
  select(-c(max_cnt, perc_week))
# check_plot <- ggplot(weekly_count_isl_trim, aes(week, cnt, group = year, color = year)) +
#   geom_line() + geom_point() +
#   facet_wrap(~year) +
#   fig_theme(legend.position = 'none') 

#colony level
max_col_yr <- data_count %>%
  filter(intern_data != 'Y') %>%
  select(year, week, site, PG_count) %>%
  distinct() %>%
  group_by(year, site) %>%
  summarize(max_cnt = max(PG_count, na.rm = T)) 
week_perc_yr <- data_count %>%
  filter(intern_data != 'Y') %>%
  select(year, week, site, PG_count) %>%
  distinct() %>%
  merge(max_col_yr, by = c('year', 'site')) %>%
  transform(perc_week = PG_count/max_cnt)

weekly_count_col_trim <- week_perc_yr %>%
  filter(perc_week > 0.49) %>%
  select(-c(max_cnt, perc_week))
# check_plot <- ggplot(weekly_count_col_trim, aes(week, PG_count, group = year, color = year)) +
#   geom_line() + geom_point() +
#   facet_wrap(~site) +
#   fig_theme(legend.position = 'none')


### count data moving forward: weekly_count_col_trim and weekly_count_isl_trim
write.csv(weekly_count_col_trim, "weekly_count_col_trim.csv", row.names = F)
write.csv(weekly_count_isl_trim, "weekly_count_isl_trim.csv", row.names = F)
```


#Data Availability and Status

###Adult counts  
+ 2008-2017 Whidbey
+ Have added intern counts for 2010, 2011, 2012 at Rolling Hills, Harrington, Mutiny Sands, and Shore Meadows (multiple counts/day, once/week); 
+ Intern data are different depending on the intern/year. 2010-2012 is timed counts for 4-5 hours, more recent years are one count per day but multiple survey days per week. Can these be combined for multiple counts per week?  

+ South Sound: Terence's intern is working on it.
+ Sequim: spoke with Ed and Jeff - must be pulled from website (Ryan)

###Prey deliveries/nest survival  
+ 2008-2014: needs a lot of checking  
+ 2015-2017: must be compiled by hand (Ryan)
+ Intern data 2010-2012 does not contain non-prey visits (VB), which means it is hard to confirm the survey started before prey were being delivered. Apparently they use the 3-week delivery criteria for a successful fledge. I'm thinking we can improve on that, because they probably don't exclude weeks where deliveries have already started.

###Quality control  
+ (mis)matching site-date combinations  
+ Prey deliveries when PG_count = 0
+ 10% of cases where day-level total visits doesn't match summed burrow-level visits

###Questions for Frances  
+ Why do some colonies have so few observation days (Coupeville Wharf)
+ Why wouldn't a colony have data for a given year (Hancock South, 2016)



```{r, results = 'hide', message = FALSE}
##Questions to answer and issues to fix

##UPDATE - dfs are separate now, so will have to do fancier magic to look at these issues
#There are a few cases where PG_count is zero and there are prey deliveries
# mystery_prey <- data %>%
#   filter(PG_count == 0 & burrow_visits_day > 0)
# 
# #~330 instances where the count of VB at the burrow-level does not equal 
# #what is noted at the site level for a given day
# ##are certain years (or sites) the culprits?
# bsums <- data %>%
#   group_by(site, date, year, burrow_visits_day) %>%
#   summarize(cnt = sum(burrow_visit, na.rm = T)) %>%
#   filter(burrow_visits_day != cnt) %>%
#   nrow()/nrow(data)

```

```{r, results = 'hide', message = FALSE}

##data exploration

#check duplicate site-date-burrow: no burrow_name has more than one row per date - no duplictes
dups <- data_burrow %>%
  group_by(site, date, burrow_name) %>%
  summarize(cnt = n_distinct(date)) %>%
  filter(cnt > 1) %>% nrow()

#consistency in number of week observations per site per season
weeks <- data_count %>% 
  filter(intern_data != "Y") %>%
  group_by(site, year) %>%
  summarize(start_week = min(week), end_week = max(week)) %>%
  transform(study_length = end_week - start_week)

weeks_plot_data <- weeks %>% 
  group_by(site) %>%
  summarize(ymin = min(study_length), ymax = max(study_length), 
            mean = mean(study_length), se = se(study_length)) %>%
  merge(weeks, by = "site")

#too busy
# weeks_plot <- ggplot(weeks_plot_data, aes(year, study_length, group = site, color = site)) +
#   geom_linerange(aes(ymin = ymin, ymax = ymax), position = position_dodge(width = 1.5), size = 0.8) +
#   geom_point(aes(x = year, y = mean), position = position_dodge(width = 1.5)) +
#   fig_theme(legend.position = 'none')

weeks_plot <- ggplot(weeks_plot_data, aes(as.numeric(as.character(year)), study_length)) +
  geom_line() + geom_point() +
  xlab("") + ylab("Number of Weeks") +
  facet_wrap(~site) + fig_theme()

weeks_range <- ggplot(weeks_plot_data, aes(as.numeric(as.character(year)), study_length)) +
  geom_linerange(aes(ymin = ymin, ymax = ymax)) + geom_point() +
  xlab("") + ylab("Number of Weeks") + scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016)) +
  facet_wrap(~site) + fig_theme()

#differences in start weeks over years?
#visually inspected 'weeks' - mostly start within three weeks across years, aside from an early 
#start in 2008 in a few sites and a very late start in 2009

#check number of burrows per site across years: looks fairly consistent with the exception of shore meadows (2010) and double bluff north/south (2010)
burrow_count <- data_burrow %>% 
  filter(intern_data != 'Y') %>%
  group_by(site, year) %>%
  summarize(cnt = n_distinct(burrow_name))

burrow_count_plot <- ggplot(burrow_count, aes(as.numeric(as.character(year)), cnt)) +
  geom_line() + geom_point() +
  xlab("") + ylab("Number of Burrows") +
  facet_wrap(~site) + fig_theme()

#number of years of data per site: 30 of the 40 unique site names have more than two years of data
site_yrs <- data_count %>%
  group_by(site) %>%
  summarize(cnt = n_distinct(year)) %>%
  filter(cnt > 2) %>% nrow()
  

```

###Burrow counts and study length  

Number of burrows identified per site per year seems reasonably consistent (ignore year > 2014). Some sites range more than others in terms of how long the study was conducted each year.  Not all sites can be used for looking at nest fate.
```{r, results = 'hide', message = FALSE}
burrow_count_plot

weeks_range

```


###Adult counts  

Many sites show relative consistency in the average number of adults counted per week across years. This consistency is also reflected at the island-level. Counts dropped in 2015.

```{r, results = 'hide', message = FALSE}

##colony-level counts over the season - mean per week across years

col_count_week_data <- data_count %>%
  filter(intern_data != "Y") %>%
  select(site, week, year, PG_count) %>%
  group_by(site, week) %>%
  summarize(mean_cnt = mean(PG_count, na.rm = T), se = se(PG_count, na.rm = T))

col_count_week <- ggplot(col_count_week_data, #filtering for cases that have more than one year/week for now
       aes(week, mean_cnt, group = site, color = site)) +
  geom_line() + geom_point() + scale_x_continuous(limit = c(0,15), breaks = c(3,6,9,12),
                                                labels = c(3,6,9,12)) +
  geom_ribbon(aes(ymin = mean_cnt - se, ymax = mean_cnt + se), alpha = 0.4, linetype = 'blank') +
  xlab("Week") + ylab("Mean Weekly Count") +
  facet_wrap(~site) +
  fig_theme(legend.position = 'none')

#island-level total; sum of season average across colony sites

island_count_yr <- data_count %>%
  filter(intern_data != 'Y') %>%
  select(site, week, year, PG_count, date) %>%
  distinct() %>%
  group_by(week, year) %>%
  summarize(cnt = sum(PG_count, na.rm = T)) %>% #sum across colonies
  group_by(year) %>%
  summarize(PG_count = mean(cnt, na.rm = T)) #mean of weeks

island_count_yr_trim <- weekly_count_isl_trim %>%
  group_by(year) %>%
  summarize(PG_count = mean(cnt, na.rm = T))

tot_compare <- island_count_yr %>%
  merge(island_count_yr_trim, by = "year", suffixes = c("", ".trim")) %>%
  melt(id.vars = "year")

# isl_tot <- ggplot(island_count_yr, aes(as.numeric(as.character(year)), PG_count)) +
#   geom_point() + xlab("") + ylab("Sum of Season Averages across All Sites") +
#   geom_line() + 
#   scale_x_continuous(breaks = 2008:2017) +
#   fig_theme_1(legend.position = 'none')
tst <- ggplot(tot_compare, aes(as.numeric(as.character(year)), value, group = variable, col = variable)) +
  geom_point() + xlab("") + ylab("Sum of Weekly Colony Counts Averaged across Weeks") +
  geom_line() + 
  scale_x_continuous(breaks = 2008:2017) +
  fig_theme_1(legend.position = 'top')

#island-level average; averages across dates and across colony sites - more consistent than I expected?
#should zeros be included here?
island_mean <- data_count %>% 
  filter(intern_data != "Y") %>%
  group_by(year) %>%
  summarize(mean_cnt = mean(PG_count, na.rm = T), 
            se = se(PG_count, na.rm = T))

isl_mean <- ggplot(island_mean, aes(as.numeric(as.character(year)), mean_cnt)) +
  geom_line() +
  geom_ribbon(aes(ymin = mean_cnt - se, ymax = mean_cnt + se), alpha = 0.4, linetype = 'blank') +
  xlab("") + ylab("Mean Daily Site Count") + scale_x_continuous(breaks = 2008:2017) +
  fig_theme_1()


```


```{r, results = 'hide', message = FALSE}
col_count_week
isl_mean
isl_tot
check_plot
```

####Multiple counts - intern data  

We have multiple counts for ~5 colonies. For 2010-2012, we have 10-11 counts per week. For 2015-2017, we have 2-3 counts per week. Variation is less in earlier years because there are 10 counts on the same day, and so are less affected by anything that could be different throughout the week - some days may just be quieter than others (weather/ocean conditions, feeding opportunities, beach disturbance), so probably best not to combine the two types?  

The group made a point to estimate fledgling success in 2013 for 2009-2013.  
```{r, results = 'hide', message = FALSE}
intern_counts <- data_count %>%
  filter(intern_data == 'Y') %>%
  transform(week_year = strftime(date, format = "%V")) %>%
  transform(week = as.numeric(week_year)) 

intern_week_counts <- intern_counts %>%
  group_by(site, year, week) %>%
  summarize(cnt = n_distinct(id))

int_count_data <- intern_counts %>%
  group_by(site, year, week) %>%
  summarize(mean_cnt = mean(PG_count), se = se(PG_count))

int_count <- ggplot(int_count_data, aes(week, mean_cnt)) +
  geom_line() + geom_point() +
  geom_ribbon(aes(ymin = mean_cnt - se, ymax = mean_cnt + se), alpha = 0.4, linetype = 'blank') +
  xlab("") + ylab("Mean Weekly Site Count") +
  facet_wrap(~site + year) +
  scale_x_continuous(limit = c(0,15), breaks = c(3,6,9,12), labels = c(3,6,9,12)) +
  fig_theme()

int_count

```


```{r}

#assumptions testing

#daily counts at island level
# island_counts_daily <- data %>%
#   select(year, date, week, PG_count) %>%
#   filter(!is.na(PG_count)) %>% distinct()
# 
# mod <- lm(PG_count ~ year + week, data = island_counts_daily)
# gvlma(mod)

#daily counts at colony level
site_counts_daily <- data_count %>% 
  filter(intern_data != 'Y') %>%
  select(year, date, week, site, PG_count) %>% 
  filter(!is.na(PG_count)) %>% distinct()

mod <- lm(PG_count ~ year + site, data = site_counts_daily)
#mod <- lm(PG_count ~ year + site + week, data = site_counts_daily)
par(mfrow = c(2, 2))
plot(mod)
gvlma(mod)

#yearly counts at colony level
site_counts_yearly <- data_count %>% 
  group_by(site, year, week) %>%
  summarize(mean_cnt = mean(PG_count, na.rm = T), 
            se = se(PG_count, na.rm = T))

mod_1<- lm(mean_cnt ~ year + site, data = site_counts_yearly)
# summary(mod_1)
# gvlma(mod_1)
# plot(mod_1)


```

###Prey deliveries

My suspicion is that the seasonal deliveries pattern/peak is smoothed out across years, which is why it is more evident in the island-level figure than at each site.  
```{r, results = 'hide', message = FALSE}
#prey delivery timing

#all prey deliveries - colony level
prey_dels_daily <- data_burrow %>% filter(as.numeric(year) < 8) %>%
  group_by(week, site) %>% 
  summarize(mean_dels = mean(tot_prey, na.rm = T), se = se(tot_prey, na.rm = T)) %>% #week averages across years
  filter(!is.na(mean_dels)) #taking out single-year rows, I think
ggplot(prey_dels_daily, 
       aes(week, mean_dels, group = site, color = site)) +
  geom_line() + geom_point() + scale_x_continuous(limit = c(0,16), breaks = c(3,6,9,12,15),
                                                labels = c(3,6,9,12,15)) +
  geom_ribbon(aes(ymin = mean_dels - se, ymax = mean_dels + se), alpha = 0.4, linetype = 'blank') +
  xlab("Week") + ylab("Mean Weekly Prey Deliveries") +
  facet_wrap(~site) + 
  #scale_color_brewer(values = color3) +
  fig_theme_1(legend.position = 'none')

#all prey deliveries - island level
isl_prey_dels_weekly <- data_burrow %>% filter(as.numeric(year) < 8) %>%
  group_by(week, year) %>% 
  summarize(tot_dels = sum(tot_prey, na.rm = T)) %>% #first sum all sites
  group_by(week) %>%
  summarize(mean_dels = mean(tot_dels, na.rm = T), se = se(tot_dels, na.rm = T)) #mean of years
ggplot(isl_prey_dels_weekly, 
       aes(week, mean_dels)) +
  geom_line() + geom_point() + scale_x_continuous(limit = c(0,16), breaks = c(3,6,9,12,15),
                                                labels = c(3,6,9,12,15)) +
  geom_ribbon(aes(ymin = mean_dels - se, ymax = mean_dels + se), alpha = 0.4, linetype = 'blank') +
  xlab("Week") + ylab("Mean Weekly Prey Deliveries") +
  fig_theme_1(legend.position = 'none') 

```

```{r, results = 'hide', message = FALSE}
  
#all visits (prey and no prey) according to counts df (rather than burrow level); not sure if this is meaningful

# #island-level
# isl_tot_visits_weekly <- data %>% 
#   group_by(week, year) %>%
#   summarize(tot_visits = sum(burrow_visits_day), na.rm = T) %>% #first sum all sites
#   group_by(week) %>%
#   summarize(mean_visits = mean(tot_visits, na.rm = T), se = se(tot_visits, na.rm = T))
# ggplot(isl_tot_visits_weekly, 
#        aes(week, mean_visits)) +
#   geom_line() + geom_point() + scale_x_continuous(limit = c(0,16), breaks = c(3,6,9,12,15),
#                                                 labels = c(3,6,9,12,15)) +
#   geom_ribbon(aes(ymin = mean_visits - se, ymax = mean_visits + se), alpha = 0.4, linetype = 'blank') +
#   xlab("Week") + ylab("Mean Weekly Total Visits") +
#   fig_theme(legend.position = 'none') 
# 
# #colony-level
# tot_visits_weekly <- data %>%
#   group_by(week, site) %>% 
#   summarize(mean_BV = mean(burrow_visits_day, na.rm = T), se = se(burrow_visits_day, na.rm = T)) #week averages across years
# ggplot(tot_visits_weekly, 
#        aes(week, mean_BV, group = site, color = site)) +
#   geom_line() + geom_point() + scale_x_continuous(limit = c(0,16), breaks = c(3,6,9,12),
#                                                 labels = c(3,6,9,12)) +
#   geom_ribbon(aes(ymin = mean_BV - se, ymax = mean_BV + se), alpha = 0.4, linetype = 'blank') +
#   xlab("Week") + ylab("Mean Weekly Burrow Visits") +
#   facet_wrap(~site) +
#   fig_theme(legend.position = 'none')
#   

```

```{r}

#use prey_weeks, prey_weeks_range column more believable until further exploration

#have range of prey deliveries changed over time? Is it different at different colonies?

prey_weeks_mean <- prey_weeks %>%
  group_by(year, site) %>%
  summarize(mean_cnt = mean(prey_week_range)) %>%
  transform(year = as.numeric(as.character(year)))
plot <- ggplot(prey_weeks_mean, aes(year, mean_cnt)) +
  geom_point() +
  geom_smooth(data = prey_weeks_mean, aes(year, mean_cnt), 
              method = "loess", se = FALSE, col = 'black', linetype = 3) +
  fig_theme()

#looks like slight increase in mean range of weeks over time... maybe coinciding with potential increase in
#study length?
#summary(lm(mean_cnt ~ year, data = prey_weeks_mean))
  

#tot burrows per colony per year for denominators
tot_burrow <- prey_weeks %>%
  group_by(year, site) %>%
  summarize(tot = n_distinct(burrow_name))

#perc success at colony level
perc_suc_col <- prey_weeks %>%
  filter(prey_week_range > 2) %>%
  group_by(year, site) %>%
  summarize(cnt = n_distinct(burrow_name)) %>%
  merge(tot_burrow, by = c('year', 'site')) %>%
  transform(perc_suc = round((cnt/tot), 2)) %>%
  transform(year = as.numeric(as.character(year)))
summary(lm(year ~ perc_suc, data = perc_suc_col)) #perc success increasing over time

ggplot(perc_suc_col, aes(year, perc_suc)) +
  geom_point() +
  geom_smooth() +
  fig_theme_1()

#perc fledgling success at island level
tot_burrow_isl <- prey_weeks %>%
  group_by(year) %>%
  summarize(tot = n_distinct(burrow_name))
perc_suc_isl <- prey_weeks %>%
  filter(prey_week_range > 2) %>%
  group_by(year) %>%
  summarize(cnt = n_distinct(burrow_name)) %>%
  merge(tot_burrow_isl, by = c('year')) %>%
  transform(perc_suc = round((cnt/tot), 2)) %>%
  transform(year = as.numeric(as.character(year)))

summary(lm(year ~ perc_suc, perc_suc_isl)) #increasing success

ggplot(perc_suc_isl, aes(year, perc_suc)) +
  geom_point() + geom_smooth() +
  fig_theme_1()

# ggplot(prey_weeks, aes(burrow_name, prey_length)) +
#   geom_linerange(aes(ymin = start_prey, ymax = end_prey)) + 
#   geom_point() + coord_flip() + geom_hline(aes(yintercept = 3), lty = 3, col = 'grey30') +
#   xlab("Burrow") + ylab("Weeks") + 
#   facet_wrap(~year + site) + 
#   scale_y_continuous(breaks = c(2, 4, 6, 8, 10, 12)) +
#   fig_theme()

write.csv(perc_suc_col, "perc_suc_col.csv", row.names = F)
write.csv(perc_suc_isl, "perc_suc_isl.csv", row.names = F)


```

```{r}

#number of potential fledglings per colony and at island level

#colony level

#number of fledglings
fledge_col <- prey_weeks %>%
  filter(prey_week_range > 2) %>%
  group_by(year, site) %>%
  summarize(cnt = n_distinct(burrow_name)) %>%
  transform(year = as.numeric(as.character(year)))
summary(lm(year ~ cnt, data = fledge)) #no change over time

ggplot(fledge, aes(year, cnt)) +
  geom_point() +
  geom_smooth() +
  fig_theme_1()

#island level

#number of fledglings
fledge_isl <- prey_weeks %>%
  filter(prey_week_range > 2) %>%
  group_by(year) %>%
  summarize(cnt = n_distinct(burrow_name)) %>%
  transform(year = as.numeric(as.character(year)))
summary(lm(year ~ cnt, data = fledge_isl)) #no change over time

ggplot(fledge_isl, aes(year, cnt)) +
  geom_point() +
  geom_smooth() +
  fig_theme_1()

```

###Prey composition

Not sure we have a use for this, but I was mainly interested in looking for (in)consistencies and general patterns.
```{r, results = 'hide', message = FALSE}
#prey delivery composition

#prey composition over the season - island level
isl_prey_comp <- data_burrow %>%
  filter(tot_prey > 0) %>% #I think just want cases where there were prey
  group_by(week, year) %>%
  summarize(Gunnel = sum(Gunnel), Sculpin = sum(Sculpin), Other = sum(Other)) %>%
  group_by(week) %>%
  summarize(Gunnel = mean(Gunnel), Sculpin = mean(Sculpin), Other = mean(Other)) %>%
  melt(id.vars = "week")
ggplot(isl_prey_comp, aes(week, value, group = variable, fill = variable)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  xlab("Week") + ylab("Mean Prey Deliveries") + 
  fig_theme_1(legend.position = 'top') + scale_fill_manual(values = color3) 

#density plot
isl_prey_comp_dens <- data_burrow %>%
  select(date, Gunnel, Sculpin, Other) %>%
  melt(id.vars = "date") %>%
  filter(value > 0) %>%
  transform(yday = yday(date))
# ggplot(isl_prey_comp_dens, aes(yday, color = variable)) +
#   geom_line(stat = 'density') + 
#   geom_rug(sides = "b", aes(y = 0), position = 'jitter', alpha = 0.25) +
#   xlab("") + ylab("Density") + 
#   fig_theme() + scale_color_manual(values = color3) +
#   scale_fill_manual(values = color3) +
#   scale_y_continuous(limit = c(0, 0.03)) +
#   scale_x_continuous(limit = c(150, 270), breaks = c(150, 180, 210, 240, 270),
#                      labels = c('Jun', 'Jul', 'Aug', 'Sep', 'Oct'))

#prey composition over the season - colony level
col_prey_comp <- data_burrow %>%
  filter(tot_prey > 0) %>%
  group_by(week, site) %>%
  summarize(Gunnel = mean(Gunnel, na.rm = T), 
            Sculpin = mean(Sculpin, na.rm = T), 
            Other = mean(Other, na.rm = T)) %>%
  melt(id.vars = c("week", "site"))
ggplot(col_prey_comp, aes(week, value, fill = variable)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  xlab("Week") + ylab("Mean Prey Deliveries") +
  facet_wrap(~site) +
  fig_theme(legend.position = 'bottom') + scale_fill_manual(values = color3) 

```

```{r}

#get pseudo success rate per site per season based on 5-weeks to fledge


```

